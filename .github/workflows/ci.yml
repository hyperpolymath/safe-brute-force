# SPDX-License-Identifier: PMPL-1.0
# GitHub Actions CI/CD for SafeBruteForce
# Erlang/OTP + LFE project

name: CI

on:
  push:
    branches: [ main, develop, claude/* ]
  pull_request:
    branches: [ main, develop ]
  schedule:
    # Run tests daily at 2 AM UTC
    - cron: '0 2 * * *'

env:
  OTP_VERSION: '26.2'
  REBAR3_VERSION: '3.22.1'

jobs:
  ###########################################################################
  # Build Job
  ###########################################################################
  build:
    name: Build
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Erlang/OTP
        uses: erlef/setup-beam@v1
        with:
          otp-version: ${{ env.OTP_VERSION }}
          rebar3-version: ${{ env.REBAR3_VERSION }}

      - name: Cache build artifacts
        uses: actions/cache@v3
        with:
          path: |
            _build
            ~/.cache/rebar3
          key: ${{ runner.os }}-build-${{ hashFiles('rebar.config') }}-${{ hashFiles('rebar.lock') }}
          restore-keys: |
            ${{ runner.os }}-build-

      - name: Get dependencies
        run: rebar3 get-deps

      - name: Compile
        run: rebar3 compile

      - name: Upload build artifacts
        uses: actions/upload-artifact@v3
        with:
          name: build-artifacts
          path: _build/
          retention-days: 1

  ###########################################################################
  # Test Jobs
  ###########################################################################
  test:
    name: Test (OTP ${{ matrix.otp }})
    runs-on: ubuntu-latest
    needs: build

    strategy:
      matrix:
        otp: ['26', '27']
      fail-fast: false

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Erlang/OTP
        uses: erlef/setup-beam@v1
        with:
          otp-version: ${{ matrix.otp }}
          rebar3-version: ${{ env.REBAR3_VERSION }}

      - name: Download build artifacts
        uses: actions/download-artifact@v3
        with:
          name: build-artifacts
          path: _build/

      - name: Run tests
        run: rebar3 lfe test

      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v3
        with:
          name: test-results-otp${{ matrix.otp }}
          path: _build/test/logs/
          retention-days: 7

  ###########################################################################
  # Coverage Job
  ###########################################################################
  coverage:
    name: Test Coverage
    runs-on: ubuntu-latest
    needs: build

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Erlang/OTP
        uses: erlef/setup-beam@v1
        with:
          otp-version: ${{ env.OTP_VERSION }}
          rebar3-version: ${{ env.REBAR3_VERSION }}

      - name: Download build artifacts
        uses: actions/download-artifact@v3
        with:
          name: build-artifacts
          path: _build/

      - name: Run tests with coverage
        run: rebar3 lfe test --cover

      - name: Generate coverage report
        run: rebar3 cover --verbose

      - name: Upload coverage to Codecov
        uses: codecov/codecov-action@v3
        with:
          files: _build/test/cover/cobertura.xml
          fail_ci_if_error: false
          verbose: true

  ###########################################################################
  # Static Analysis
  ###########################################################################
  dialyzer:
    name: Dialyzer Static Analysis
    runs-on: ubuntu-latest
    needs: build

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Erlang/OTP
        uses: erlef/setup-beam@v1
        with:
          otp-version: ${{ env.OTP_VERSION }}
          rebar3-version: ${{ env.REBAR3_VERSION }}

      - name: Cache PLT
        uses: actions/cache@v3
        with:
          path: _build/default/*_plt
          key: ${{ runner.os }}-plt-${{ hashFiles('rebar.config') }}
          restore-keys: |
            ${{ runner.os }}-plt-

      - name: Download build artifacts
        uses: actions/download-artifact@v3
        with:
          name: build-artifacts
          path: _build/

      - name: Run Dialyzer
        run: rebar3 dialyzer
        continue-on-error: true

  ###########################################################################
  # Security Checks
  ###########################################################################
  security:
    name: Security Checks
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Check for hardcoded secrets
        run: |
          echo "Checking for hardcoded passwords..."
          ! grep -r "password\s*=" src/ || (echo "‚ùå Found hardcoded passwords" && exit 1)
          echo "‚úì No hardcoded passwords found"

          echo "Checking for API keys..."
          ! grep -r "api_key\s*=" src/ || (echo "‚ùå Found hardcoded API keys" && exit 1)
          echo "‚úì No hardcoded API keys found"

      - name: Verify safety mechanisms
        run: |
          echo "Checking for pause mechanism..."
          grep -r "pause_interval" src/ || (echo "‚ùå Pause mechanism missing!" && exit 1)
          echo "‚úì Pause mechanism verified"

          echo "Checking for rate limiting..."
          grep -r "rate_limit" src/ || (echo "‚ùå Rate limiting missing!" && exit 1)
          echo "‚úì Rate limiting verified"

  ###########################################################################
  # RSR Compliance Check
  ###########################################################################
  rsr-compliance:
    name: RSR Framework Compliance
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Check required files
        run: |
          echo "Checking RSR Bronze Level compliance..."

          echo "‚úì Checking core documentation..."
          test -f README.md || (echo "‚ùå README.md missing" && exit 1)
          test -f LICENSE || (echo "‚ùå LICENSE missing" && exit 1)
          test -f CHANGELOG.md || (echo "‚ùå CHANGELOG.md missing" && exit 1)
          test -f CODE_OF_CONDUCT.md || (echo "‚ùå CODE_OF_CONDUCT.md missing" && exit 1)
          test -f MAINTAINERS.md || (echo "‚ùå MAINTAINERS.md missing" && exit 1)

          echo "‚úì Checking documentation directory..."
          test -f docs/CONTRIBUTING.md || (echo "‚ùå CONTRIBUTING.md missing" && exit 1)
          test -f docs/SECURITY.md || (echo "‚ùå SECURITY.md missing" && exit 1)
          test -f docs/USAGE.md || (echo "‚ùå USAGE.md missing" && exit 1)
          test -f docs/API_REFERENCE.md || (echo "‚ùå API_REFERENCE.md missing" && exit 1)
          test -f docs/QUICKSTART.md || (echo "‚ùå QUICKSTART.md missing" && exit 1)

          echo "‚úì Checking .well-known directory..."
          test -f .well-known/security.txt || (echo "‚ùå security.txt missing" && exit 1)
          test -f .well-known/ai.txt || (echo "‚ùå ai.txt missing" && exit 1)
          test -f .well-known/humans.txt || (echo "‚ùå humans.txt missing" && exit 1)

          echo "‚úì Checking build system..."
          test -f rebar.config || (echo "‚ùå rebar.config missing" && exit 1)
          test -f Makefile || (echo "‚ùå Makefile missing" && exit 1)

          echo ""
          echo "üéâ RSR Bronze Level Compliance: VERIFIED"
          echo ""
          echo "RSR Compliance Checklist:"
          echo "‚úì Documentation complete"
          echo "‚úì .well-known/ directory present"
          echo "‚úì Build system configured"
          echo "‚úì Code of Conduct adopted"
          echo "‚úì Security policy defined"
          echo "‚úì License specified (MIT)"
          echo "‚úì Contribution guidelines available"
          echo "‚úì Maintainers documented"
          echo ""
          echo "TPCF Perimeter: 3 (Community Sandbox)"

      - name: Validate security.txt (RFC 9116)
        run: |
          echo "Validating security.txt format..."
          grep -q "Contact:" .well-known/security.txt || (echo "‚ùå Missing Contact field" && exit 1)
          grep -q "Expires:" .well-known/security.txt || (echo "‚ùå Missing Expires field" && exit 1)
          echo "‚úì security.txt format valid"

  ###########################################################################
  # Documentation
  ###########################################################################
  docs:
    name: Build Documentation
    runs-on: ubuntu-latest
    needs: build

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Erlang/OTP
        uses: erlef/setup-beam@v1
        with:
          otp-version: ${{ env.OTP_VERSION }}
          rebar3-version: ${{ env.REBAR3_VERSION }}

      - name: Download build artifacts
        uses: actions/download-artifact@v3
        with:
          name: build-artifacts
          path: _build/

      - name: Build EDoc
        run: rebar3 edoc
        continue-on-error: true

      - name: Upload documentation
        uses: actions/upload-artifact@v3
        with:
          name: documentation
          path: doc/
          retention-days: 30

  ###########################################################################
  # Release (on tags)
  ###########################################################################
  release:
    name: Create Release
    runs-on: ubuntu-latest
    needs: [test, coverage, security, rsr-compliance]
    if: startsWith(github.ref, 'refs/tags/v')

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Erlang/OTP
        uses: erlef/setup-beam@v1
        with:
          otp-version: ${{ env.OTP_VERSION }}
          rebar3-version: ${{ env.REBAR3_VERSION }}

      - name: Build release
        run: |
          rebar3 as prod release
          rebar3 as prod tar

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          files: _build/prod/rel/safe_brute_force/*.tar.gz
          generate_release_notes: true
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  ###########################################################################
  # Notify
  ###########################################################################
  notify:
    name: Notify on Failure
    runs-on: ubuntu-latest
    needs: [test, coverage, security, rsr-compliance]
    if: failure()

    steps:
      - name: Notify failure
        run: |
          echo "‚ùå CI Pipeline Failed"
          echo "Please check the logs for details"
